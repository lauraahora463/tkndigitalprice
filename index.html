<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Cotizaciones y Análisis Técnico</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Estilos Base: Fondo oscuro y fuente */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #e6e6e6;
            min-height: 100vh;
        }

        /* Contenedor de la gráfica y Card de Contenido */
        #chartContainer {
            height: 55vh; 
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            background-color: #161b22;
        }

        #cryptoChart {
            display: block;
            background-color: transparent;
        }

        .content-card {
            background-color: #161b22;
            border: 1px solid #2d333b;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* Estilo para el input y el botón de despliegue del acordeón */
        .accordion-content {
            max-height: 0;
            opacity: 0;
            transition: max-height 0.5s ease-in-out, opacity 0.4s ease-in-out, padding 0.5s;
            overflow: hidden;
            padding-top: 0;
        }

        .accordion-content.open {
            max-height: 500px;
            opacity: 1;
            padding-top: 1rem;
        }

        /* Estilo para los formularios y botones de Auth */
        .auth-input {
            background-color: #2d333b;
            border: 1px solid #484f58;
            color: #e6e6e6;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .auth-input:focus {
            border-color: #38bdf8;
        }

        .auth-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        /* Estilo para el botón de ordenar activo */
        .auth-btn.active {
            background-color: #38bdf8; /* Azul */
            color: #0d1117;
        }
        
        .auth-btn:hover {
            transform: translateY(-1px);
        }

        /* --- Estilos de Scroll (Sin cambios) --- */
        .scroll-reveal {
            opacity: 0;
            transform: translateX(-100px);
            transition: opacity 1s ease-out, transform 1s ease-out;
            will-change: opacity, transform;
        }

        .scroll-reveal.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .scroll-reveal:nth-child(even) {
            transform: translateX(100px);
        }

        .scroll-reveal:nth-child(even).visible {
            transform: translateX(0);
        }

        /* Responsividad */
        @media (max-width: 768px) {
            #chartContainer {
                height: 45vh;
            }
        }
    </style>
</head>

<body class="p-4 flex flex-col items-center">

    <header class="w-full max-w-7xl text-center py-4 mb-4">
        <h1 class="text-4xl font-extrabold text-teal-400">Herramientas fundamentales de arbitraje</h1>
    </header>

    <div class="w-full max-w-7xl flex flex-col md:flex-row justify-between gap-4 mb-6">

        <div id="price-panel" class="w-full md:w-2/3 bg-[#161b22] p-4 rounded-lg shadow-xl border border-teal-500/50">

            <div id="realtime-rates" class="mt-4 pt-3">
                <h3 class="text-lg font-bold text-teal-300 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                    Cotizaciones Dólar (CriptoYa)
                </h3>
                <div id="rates-list" class="text-sm text-gray-300 space-y-1">
                    <p>💵 Dólar Blue: <span id="rate-blue" class="font-semibold text-green-400">Cargando...</span></p>
                    <p>🏦 Dólar Oficial: <span id="rate-oficial" class="font-semibold text-green-400">Cargando...</span>
                    </p>
                    <p>📊 Dólar MEP (AL30): <span id="rate-mep" class="font-semibold text-green-400">Cargando...</span></p>
                    <p>💼 Dólar CCL (AL30): <span id="rate-ccl" class="font-semibold text-green-400">Cargando...</span></p>
                </div>
            </div>
        </div>

        <div id="auth-panel"
            class="w-full md:w-1/3 bg-[#161b22] p-4 rounded-lg shadow-xl border border-purple-500/50 flex flex-col justify-center">
            </div>

    </div>

    <div class="w-full max-w-7xl mb-4 flex flex-col md:flex-row justify-end gap-2">
        <button id="sort-price-desc" class="auth-btn bg-indigo-600 hover:bg-indigo-700 text-white active">Ordenar por Precio (Mayor a Menor)</button>
        <button id="sort-price-asc" class="auth-btn bg-gray-600 hover:bg-gray-700 text-white">Ordenar por Precio (Menor a Mayor)</button>
        <button id="sort-variation" class="auth-btn bg-gray-600 hover:bg-gray-700 text-white">Ordenar por Variación</button>
        <button id="sort-name" class="auth-btn bg-gray-600 hover:bg-gray-700 text-white">Ordenar por Nombre</button>
    </div>
    
    <div id="chartContainer" class="p-2 mb-10 w-full max-w-7xl">
        <canvas id="cryptoChart"></canvas>
    </div>

    <main class="w-full max-w-7xl px-4 md:px-0">
        <h2 class="text-3xl font-bold text-purple-400 mb-6 border-b border-gray-700 pb-2">Herramientas Clave de Análisis
            Gráfico</h2>
        <div class="grid md:grid-cols-2 gap-6 mb-12">
            <div class="content-card scroll-reveal">
                <div class="flex items-center justify-between cursor-pointer" onclick="toggleAccordion(this)">
                    <h3 class="text-xl font-bold text-gray-200 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                        Diferencial de Tipo de Cambio (Blue, MEP, CCL)
                    </h3>
                    <svg class="w-5 h-5 text-gray-400 transition-transform duration-500 transform rotate-0"
                        data-arrow-icon="ma" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div class="accordion-content" data-content="ma">
                    <p class="text-gray-400 text-sm mt-2">El diferencial entre los distintos tipos de cambio (oficial,
                        blue, MEP, CCL)
                        es la base del arbitraje cambiario en Argentina. Permite detectar oportunidades de ganancia al
                        operar entre
                        mercados con brechas significativas.</p>
                </div>
            </div>

            <div class="content-card scroll-reveal">
                <div class="flex items-center justify-between cursor-pointer" onclick="toggleAccordion(this)">
                    <h3 class="text-xl font-bold text-gray-200 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0h2m4 0V5a2 2 0 00-2-2h-2a2 2 0 00-2 2v14m0 0h2m2-14h2m-2 2h2m-2 4h2m-2 4h2">
                            </path>
                        </svg>
                        Spread entre Exchanges o Brokers
                    </h3>
                    <svg class="w-5 h-5 text-gray-400 transition-transform duration-500 transform rotate-0"
                        data-arrow-icon="rsi" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div class="accordion-content" data-content="rsi">
                    <p class="text-gray-400 text-sm mt-2">El spread es la diferencia entre el precio de compra y venta
                        de USD entre
                        plataformas. En arbitraje, un spread amplio entre exchanges o brokers puede aprovecharse
                        comprando en el más
                        barato y vendiendo en el más caro.</p>
                </div>
            </div>

            <div class="content-card scroll-reveal">
                <div class="flex items-center justify-between cursor-pointer" onclick="toggleAccordion(this)">
                    <h3 class="text-xl font-bold text-gray-200 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 12l2 2 4-4m5 4h.01M9 16h.01M19 16h.01M9 20h.01"></path>
                        </svg>
                        Monitoreo de Liquidez y Profundidad de Mercado
                    </h3>
                    <svg class="w-5 h-5 text-gray-400 transition-transform duration-500 transform rotate-0"
                        data-arrow-icon="bb" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div class="accordion-content" data-content="bb">
                    <p class="text-gray-400 text-sm mt-2">La liquidez determina qué tan rápido se puede ejecutar una
                        operación sin
                        afectar el precio. En arbitraje, mercados con baja liquidez pueden generar slippage y reducir la
                        rentabilidad.</p>
                </div>
            </div>

            <div class="content-card scroll-reveal">
                <div class="flex items-center justify-between cursor-pointer" onclick="toggleAccordion(this)">
                    <h3 class="text-xl font-bold text-gray-200 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 12l2 2 4-4 2 2 4-4m-12 3v3m0 3h.01M16 8h.01M9 8h.01M7 16h.01M16 16h.01"></path>
                        </svg>
                        Bots y Automatización de Arbitraje
                    </h3>
                    <svg class="w-5 h-5 text-gray-400 transition-transform duration-500 transform rotate-0"
                        data-arrow-icon="macd" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div class="accordion-content" data-content="macd">
                    <p class="text-gray-400 text-sm mt-2">Los bots de arbitraje ejecutan operaciones automáticas
                        aprovechando brechas de
                        precio entre diferentes mercados o tipos de cambio. Permiten reaccionar en milisegundos, algo
                        imposible
                        manualmente.</p>
                </div>
            </div>
        </div>
    </main>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTES DEL DOM Y CONFIGURACIÓN ---
            const chartCanvas = document.getElementById('cryptoChart');
            const authPanel = document.getElementById('auth-panel');
            
            // Constantes del Ticker Panel
            const rateBlue = document.getElementById('rate-blue');
            const rateOficial = document.getElementById('rate-oficial');
            const rateMep = document.getElementById('rate-mep');
            const rateCcl = document.getElementById('rate-ccl');

            // --- CONFIGURACIÓN DEL GRÁFICO DE BARRAS ---
            const FETCH_INTERVAL = 300000; // 300,000 ms = 5 minutos
            let myBarChart; // Variable global para el gráfico
            let fullApiData = []; // Variable global para guardar los datos y poder ordenarlos
            
            // Botones de ordenar
            const sortButtons = {
                priceDesc: document.getElementById('sort-price-desc'),
                priceAsc: document.getElementById('sort-price-asc'),
                variation: document.getElementById('sort-variation'),
                name: document.getElementById('sort-name')
            };

            // --- LÓGICA DE AUTENTICACIÓN (Sin cambios) ---
            const STORAGE_KEY = 'tkn_current_user';
            let currentUser = null;
            function loadUserFromStorage() {
                const userData = localStorage.getItem(STORAGE_KEY);
                if (userData) {
                    try {
                        currentUser = JSON.parse(userData);
                    } catch (e) {
                        console.error("Error al parsear datos de usuario de localStorage", e);
                        currentUser = null;
                        localStorage.removeItem(STORAGE_KEY);
                    }
                }
            }
            function saveUserToStorage(user) {
                currentUser = {
                    email: user.email,
                    phone: user.phone || null,
                    password: user.password || null
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(currentUser));
                renderAuthPanel();
            }
            function logout() {
                currentUser = null;
                localStorage.removeItem(STORAGE_KEY);
                renderAuthPanel();
            }
            function handleRegister(email, phone, password) {
                if (!email || password.length < 6) {
                    displayMessage('El email y la contraseña (mínimo 6 caracteres) son obligatorios.', 'red');
                    return;
                }
                if (phone && isNaN(phone.replace(/\s/g, ''))) {
                    displayMessage('El campo de teléfono debe ser un número válido.', 'red');
                    return;
                }
                displayMessage(`¡Registro exitoso para ${email}! Iniciando sesión...`, 'green');
                saveUserToStorage({ email, phone, password });
            }
            function handleLogin(email, password) {
                if (!email || !password) {
                    displayMessage('Introduce tu email y contraseña.', 'red');
                    return;
                }
                if (password.length >= 6) {
                    displayMessage(`¡Bienvenido de nuevo, ${email}!`, 'green');
                    saveUserToStorage({ email });
                } else {
                    displayMessage('Credenciales incorrectas (Simulación).', 'red');
                }
            }
            function displayMessage(message, color) {
                const messageBox = authPanel.querySelector('#auth-message');
                if (messageBox) {
                    const bgColor = color === 'red' ? 'bg-red-600/80' : 'bg-green-600/80';
                    messageBox.className = `p-2 mb-3 text-sm rounded-lg text-white ${bgColor}`;
                    messageBox.textContent = message;
                    setTimeout(() => {
                        messageBox.textContent = '';
                        messageBox.className = 'mb-3';
                    }, 4000);
                }
            }
            function renderAuthPanel(mode = 'login') {
                authPanel.innerHTML = `<div id="auth-message" class="mb-3"></div>`;
                if (currentUser) {
                    const phoneDisplay = currentUser.phone ? `<p class="text-sm text-gray-400 mb-2">📞 ${currentUser.phone}</p>` : '';
                    const passwordWarning = currentUser.password ? `<p class="text-xs text-red-400 italic">⚠️ Contraseña guardada: ${currentUser.password}</p>` : '';
                    authPanel.innerHTML += `
                        <div class="text-center">
                            <h3 class="text-xl font-bold text-teal-400">Bienvenido</h3>
                            <p class="text-sm text-gray-300 truncate mb-1">📧 ${currentUser.email}</p>
                            ${phoneDisplay}
                            ${passwordWarning}
                            <button id="logout-btn" class="auth-btn bg-red-600 hover:bg-red-700 text-white w-full mt-4">Cerrar Sesión</button>
                        </div>
                    `;
                    document.getElementById('logout-btn').addEventListener('click', logout);
                } else {
                    let phoneInputHTML = '';
                    if (mode === 'register') {
                        phoneInputHTML = `<input type="tel" id="auth-phone" class="auth-input" placeholder="Teléfono (Opcional)">`;
                    }
                    const formHTML = `
                        <h3 class="text-xl font-bold text-purple-400 mb-4">${mode === 'login' ? 'Iniciar Sesión' : 'Registro'}</h3>
                        <form id="auth-form" class="flex flex-col space-y-3">
                            <input type="email" id="auth-email" class="auth-input" placeholder="Email" required>
                            ${phoneInputHTML}
                            <input type="password" id="auth-password" class="auth-input" placeholder="Contraseña (mín. 6)" required>
                            <button type="submit" class="auth-btn bg-indigo-600 hover:bg-indigo-700 text-white">
                                ${mode === 'login' ? 'Acceder' : 'Registrarse'}
                            </button>
                        </form>
                        <p class="text-center text-xs mt-3 text-gray-400">
                            ${mode === 'login'
                                ? '¿No tienes cuenta? <a href="#" id="toggle-register" class="text-purple-400 hover:text-purple-300">Regístrate</a>'
                                : '¿Ya tienes cuenta? <a href="#" id="toggle-login" class="text-purple-400 hover:text-purple-300">Inicia Sesión</a>'
                            }
                        </p>
                    `;
                    authPanel.innerHTML += formHTML;
                    document.getElementById('auth-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const email = document.getElementById('auth-email').value;
                        const password = document.getElementById('auth-password').value;
                        if (mode === 'register') {
                            const phone = document.getElementById('auth-phone').value;
                            handleRegister(email, phone, password);
                        } else {
                            handleLogin(email, password);
                        }
                    });
                    if (document.getElementById('toggle-register')) {
                        document.getElementById('toggle-register').addEventListener('click', (e) => {
                            e.preventDefault();
                            renderAuthPanel('register');
                        });
                    }
                    if (document.getElementById('toggle-login')) {
                        document.getElementById('toggle-login').addEventListener('click', (e) => {
                            e.preventDefault();
                            renderAuthPanel('login');
                        });
                    }
                }
            }
            loadUserFromStorage();
            renderAuthPanel(currentUser ? 'logged' : 'login');
            // --- FIN DE LÓGICA DE AUTENTICACIÓN ---


            // --- *** LÓGICA DE GRÁFICO CON API CRIPTOYA *** ---

            /**
             * Busca datos de CriptoYa y actualiza toda la página.
             */
            async function fetchAndUpdateData() {
                 try {
                    const res = await fetch("https://criptoya.com/api/dolar");
                    if (!res.ok) throw new Error('Error al cargar datos de CriptoYa');
                    
                    const data = await res.json();
                    
                    // 1. Actualiza el panel de Tickers (Blue, Oficial, etc.)
                    updateTickerPanel(data);
                    
                    // 2. Parsea los datos y los guarda en la variable global
                    parseApiData(data);
                    
                    // 3. Dibuja/Actualiza el gráfico (la primera vez lo inicializa)
                    // Busca el botón activo actual para mantener el orden
                    const currentSort = document.querySelector('.auth-btn.active').id.split('-').pop(); // 'desc', 'asc', 'variation', 'name'
                    let sortCriteria = 'priceDesc'; // default
                    if (currentSort === 'asc') sortCriteria = 'priceAsc';
                    if (currentSort === 'variation') sortCriteria = 'variation';
                    if (currentSort === 'name') sortCriteria = 'name';
                    
                    sortAndRedraw(sortCriteria);

                 } catch (err) {
                    console.error("Error obteniendo cotizaciones:", err);
                 }
            }
            
            /**
             * Actualiza el panel de cotizaciones (Blue, Oficial, MEP, CCL)
             */
            function updateTickerPanel(data) {
                rateBlue.textContent = data?.blue?.ask ? `$${data.blue.ask.toFixed(2)}` : "N/D";
                rateOficial.textContent = data?.oficial?.price ? `$${data.oficial.price.toFixed(2)}` : "N/D";
                rateMep.textContent = data?.mep?.al30?.["24hs"]?.price ? `$${data.mep.al30["24hs"].price.toFixed(2)}` : "N/D";
                rateCcl.textContent = data?.ccl?.al30?.["24hs"]?.price ? `$${data.ccl.al30["24hs"].price.toFixed(2)}` : "N/D";
            }
            
            /**
             * *** MODIFICADO: Parsea la respuesta de la API a un array limpio (con más datos) ***
             */
            function parseApiData(data) {
                fullApiData = [
                    // Simples
                    { 
                        name: 'Oficial', 
                        price: data.oficial?.price || 0, 
                        variation: data.oficial?.variation || 0
                    },
                    { 
                        name: 'Blue', 
                        price: data.blue?.ask || 0, 
                        variation: data.blue?.variation || 0
                    },
                    
                    // Cripto
                    { 
                        name: 'Cripto (USDT)', 
                        price: data.cripto?.usdt?.ask || 0, 
                        variation: data.cripto?.usdt?.variation || 0
                    },
                    { 
                        name: 'Cripto (USDC)', 
                        price: data.cripto?.usdc?.ask || 0, 
                        variation: data.cripto?.usdc?.variation || 0
                    },
                    { 
                        name: 'Cripto (CCB)', 
                        price: data.cripto?.ccb?.ask || 0, 
                        variation: data.cripto?.ccb?.variation || 0
                    },

                    // MEP
                    { 
                        name: 'MEP (AL30)', 
                        price: data.mep?.al30?.["24hs"]?.price || 0, 
                        variation: data.mep?.al30?.["24hs"]?.variation || 0
                    },
                    { 
                        name: 'MEP (GD30)', 
                        price: data.mep?.gd30?.["24hs"]?.price || 0, 
                        variation: data.mep?.gd30?.["24hs"]?.variation || 0
                    },
                    { 
                        name: 'MEP (Letras)', // API usa 'letras'
                        price: data.mep?.letras?.["24hs"]?.price || 0, 
                        variation: data.mep?.letras?.["24hs"]?.variation || 0
                    },
                    { 
                        name: 'MEP (BPO27)', 
                        price: data.mep?.bpo27?.["24hs"]?.price || 0, 
                        variation: data.mep?.bpo27?.["24hs"]?.variation || 0
                    },

                    // CCL
                    { 
                        name: 'CCL (AL30)', 
                        price: data.ccl?.al30?.["24hs"]?.price || 0, 
                        variation: data.ccl?.al30?.["24hs"]?.variation || 0
                    },
                    { 
                        name: 'CCL (GD30)', 
                        price: data.ccl?.gd30?.["24hs"]?.price || 0, 
                        variation: data.ccl?.gd30?.["24hs"]?.variation || 0
                    },
                    { 
                        name: 'CCL (Letras)', 
                        price: data.ccl?.letras?.["24hs"]?.price || 0, 
                        variation: data.ccl?.letras?.["24hs"]?.variation || 0
                    },
                    { 
                        name: 'CCL (BPO27)', 
                        price: data.ccl?.bpo27?.["24hs"]?.price || 0, 
                        variation: data.ccl?.bpo27?.["24hs"]?.variation || 0
                    }
                ];
                
                // Filtro para eliminar datos que vinieron en 0 (API a veces no reporta)
                fullApiData = fullApiData.filter(d => d.price > 0);
            }


            /**
             * *** MODIFICADO: Añadidos más colores para las nuevas barras ***
             */
            function initializeChart() {
                const ctx = chartCanvas.getContext('2d');
                
                // Colores para las barras
                const colors = [
                    'rgba(54, 162, 235, 0.7)', // Blue
                    'rgba(75, 192, 192, 0.7)', // Green (Teal)
                    'rgba(255, 206, 86, 0.7)', // Yellow
                    'rgba(255, 99, 132, 0.7)', // Red
                    'rgba(153, 102, 255, 0.7)', // Purple
                    'rgba(255, 159, 64, 0.7)', // Orange
                    'rgba(199, 199, 199, 0.7)', // Grey
                    'rgba(83, 109, 254, 0.7)', // Indigo
                    'rgba(0, 230, 118, 0.7)', // Light Green
                    'rgba(240, 98, 146, 0.7)', // Pink
                    'rgba(255, 238, 88, 0.7)', // Bright Yellow
                    'rgba(179, 157, 219, 0.7)', // Light Purple
                    'rgba(66, 165, 245, 0.7)'  // Light Blue
                ];
                
                myBarChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [], // Se llenará con sortAndRedraw
                        datasets: [{
                            label: 'Precio en ARS',
                            data: [], // Se llenará con sortAndRedraw
                            backgroundColor: colors,
                            borderColor: colors.map(c => c.replace('0.7', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // Oculta la leyenda (es obvio)
                            },
                            tooltip: {
                                callbacks: {
                                    // Tooltip personalizado para mostrar precio y variación
                                    label: function(context) {
                                        // Buscamos el item por el nombre para obtener la variación
                                        const item = fullApiData.find(d => d.name === context.label);
                                        const price = `Precio: $${context.raw.toFixed(2)}`;
                                        
                                        let variation = 'Variación: N/A';
                                        if (item) {
                                             variation = `Variación: ${item.variation.toFixed(2)}%`;
                                        }
                                        return [price, variation];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    color: '#e6e6e6' // Color de texto eje Y
                                },
                                grid: {
                                    color: '#2d333b' // Color de cuadrícula eje Y
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#e6e6e6' // Color de texto eje X
                                },
                                grid: {
                                    color: 'transparent' // Sin cuadrícula eje X
                                }
                            }
                        }
                    }
                });
            }

            /**
             * Actualiza el gráfico con los datos ya ordenados (Sin cambios)
             */
            function updateChart(sortedData) {
                if (!myBarChart) {
                    initializeChart();
                }
                
                // Extrae los nombres y precios del array ordenado
                myBarChart.data.labels = sortedData.map(d => d.name);
                myBarChart.data.datasets[0].data = sortedData.map(d => d.price);
                
                // Actualiza el gráfico
                myBarChart.update();
            }

            /**
             * Ordena los datos según el criterio y actualiza el gráfico (Sin cambios)
             */
            function sortAndRedraw(criteria) {
                let sortedData = [...fullApiData]; // Copia los datos para no modificar el original
                
                switch (criteria) {
                    case 'priceDesc':
                        sortedData.sort((a, b) => b.price - a.price);
                        break;
                    case 'priceAsc':
                        sortedData.sort((a, b) => a.price - a.price);
                        break;
                    case 'variation':
                        sortedData.sort((a, b) => b.variation - a.variation);
                        break;
                    case 'name':
                        sortedData.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                }
                
                // Actualiza la clase 'active' en los botones
                Object.values(sortButtons).forEach(btn => btn.classList.remove('active', 'bg-indigo-600', 'hover:bg-indigo-700'));
                Object.values(sortButtons).forEach(btn => btn.classList.add('bg-gray-600', 'hover:bg-gray-700'));
                
                let activeButton;
                if(criteria === 'priceDesc') activeButton = sortButtons.priceDesc;
                if(criteria === 'priceAsc') activeButton = sortButtons.priceAsc;
                if(criteria === 'variation') activeButton = sortButtons.variation;
                if(criteria === 'name') activeButton = sortButtons.name;
                
                activeButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                activeButton.classList.add('active', 'bg-indigo-600', 'hover:bg-indigo-700');
                
                // Llama a la función que actualiza el canvas
                updateChart(sortedData);
            }

            // --- INICIO DE EJECUCIÓN ---

            // Añadimos los listeners a los botones
            sortButtons.priceDesc.addEventListener('click', () => sortAndRedraw('priceDesc'));
            sortButtons.priceAsc.addEventListener('click', () => sortAndRedraw('priceAsc'));
            sortButtons.variation.addEventListener('click', () => sortAndRedraw('variation'));
            sortButtons.name.addEventListener('click', () => sortAndRedraw('name'));
            
            // Primera llamada al cargar
            fetchAndUpdateData();
            
            // Loop de actualización
            setInterval(fetchAndUpdateData, FETCH_INTERVAL); 


            // --- LÓGICA DE ACORDEÓN (Botón Desplegable) - Sin cambios ---
            window.toggleAccordion = function (headerElement) {
                const parentCard = headerElement.closest('.content-card');
                const content = parentCard.querySelector('.accordion-content');
                const arrowIcon = headerElement.querySelector('[data-arrow-icon]');

                content.classList.toggle('open');

                if (content.classList.contains('open')) {
                    arrowIcon.classList.remove('rotate-0');
                    arrowIcon.classList.add('rotate-180');
                } else {
                    arrowIcon.classList.remove('rotate-180');
                    arrowIcon.classList.add('rotate-0');
                }
            };

            // --- LÓGICA DE ANIMACIÓN AL HACER SCROLL (Intersection Observer) - Sin cambios ---
            const scrollRevealElements = document.querySelectorAll('.scroll-reveal');
            const observerOptions = {
                root: null,
                rootMargin: '0px',
                threshold: 0.2
            };
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);
            scrollRevealElements.forEach(el => {
                observer.observe(el);
            });

        });
    </script>
</body>

</html>